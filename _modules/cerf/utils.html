

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>cerf.utils &mdash; cerf 2.3.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/cerf.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/getting_started.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> cerf
          

          
          </a>

          
            
            
              <div class="version">
                2.3.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide.html">User guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing to <strong>cerf</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../publications.html">Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_cite.html">How to cite <strong>cerf</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../footer.html">Acknowledgement</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">cerf</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>cerf.utils</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for cerf.utils</h1><div class="highlight"><pre>
<span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">rasterio</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span>


<div class="viewcode-block" id="results_to_geodataframe"><a class="viewcode-back" href="../../cerf.html#cerf.utils.results_to_geodataframe">[docs]</a><span class="k">def</span> <span class="nf">results_to_geodataframe</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">target_crs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert the results from &#39;cerf.run()&#39; to a GeoDataFrame.</span>

<span class="sd">    :param result_df:                       Result data frame from running &#39;cerf.run()&#39;</span>
<span class="sd">    :type result_df:                        DataFrame</span>

<span class="sd">    :param target_crs:                      Coordinate reference system to assign the output.</span>

<span class="sd">    :return:                                GeoPandas GeoDataFrame of results</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># create geometry column from coordinate fields</span>
    <span class="n">geometry</span> <span class="o">=</span> <span class="p">[</span><span class="n">Point</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span> <span class="k">for</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;xcoord&#39;</span><span class="p">],</span> <span class="n">result_df</span><span class="p">[</span><span class="s1">&#39;ycoord&#39;</span><span class="p">])]</span>

    <span class="k">return</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">target_crs</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">geometry</span><span class="p">)</span></div>


<div class="viewcode-block" id="kilometers_to_miles"><a class="viewcode-back" href="../../cerf.html#cerf.utils.kilometers_to_miles">[docs]</a><span class="k">def</span> <span class="nf">kilometers_to_miles</span><span class="p">(</span><span class="n">input_km_value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert kilometers to miles.</span>

<span class="sd">    :param input_km_value:          Kilometer value to convert to miles</span>
<span class="sd">    :type input_km_value:           float, int</span>

<span class="sd">    :return:                        Miles</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">input_km_value</span> <span class="o">*</span> <span class="mf">0.621371</span></div>


<div class="viewcode-block" id="suppress_callback"><a class="viewcode-back" href="../../cerf.html#cerf.utils.suppress_callback">[docs]</a><span class="k">def</span> <span class="nf">suppress_callback</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Do not log callback output for whitebox functions.</span>

<span class="sd">    :param value:                   Value of callback</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span></div>


<div class="viewcode-block" id="empty_sited_dict"><a class="viewcode-back" href="../../cerf.html#cerf.utils.empty_sited_dict">[docs]</a><span class="k">def</span> <span class="nf">empty_sited_dict</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Initialize a sited dictionary.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;region_name&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;tech_id&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;tech_name&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;unit_size_mw&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;xcoord&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;ycoord&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;buffer_in_km&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;sited_year&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;retirement_year&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;lmp_zone&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;locational_marginal_price_usd_per_mwh&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;generation_mwh_per_year&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;operating_cost_usd_per_year&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;net_operational_value_usd_per_year&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;interconnection_cost_usd_per_year&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;net_locational_cost_usd_per_year&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;capacity_factor_fraction&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;carbon_capture_rate_fraction&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;fuel_co2_content_tons_per_btu&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;fuel_price_usd_per_mmbtu&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;fuel_price_esc_rate_fraction&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;heat_rate_btu_per_kWh&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;lifetime_yrs&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;operational_life_yrs&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;variable_om_usd_per_mwh&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;variable_om_esc_rate_fraction&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;carbon_tax_usd_per_ton&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;carbon_tax_esc_rate_fraction&#39;</span><span class="p">:</span> <span class="p">[]}</span></div>


<div class="viewcode-block" id="sited_dtypes"><a class="viewcode-back" href="../../cerf.html#cerf.utils.sited_dtypes">[docs]</a><span class="k">def</span> <span class="nf">sited_dtypes</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return data type dictionary for the sited data frame.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;region_name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;tech_id&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
            <span class="s1">&#39;tech_name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="s1">&#39;unit_size_mw&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s1">&#39;xcoord&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s1">&#39;ycoord&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s1">&#39;lmp_zone&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
            <span class="s1">&#39;locational_marginal_price_usd_per_mwh&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s1">&#39;net_operational_value_usd_per_year&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s1">&#39;interconnection_cost_usd_per_year&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s1">&#39;net_locational_cost_usd_per_year&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
            <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
            <span class="s1">&#39;retirement_year&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
            <span class="s1">&#39;sited_year&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
            <span class="s1">&#39;buffer_in_km&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">}</span></div>


<div class="viewcode-block" id="default_suitabiity_files"><a class="viewcode-back" href="../../cerf.html#cerf.utils.default_suitabiity_files">[docs]</a><span class="k">def</span> <span class="nf">default_suitabiity_files</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return a dictionary of default suitability file names.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;biomass_conv_wo_ccs&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_biomass.sdat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;biomass_conv_w_ccs&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_biomass.sdat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;biomass_igcc_wo_ccs&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_biomass_igcc.sdat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;biomass_igcc_w_ccs&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_biomass_igcc_ccs.sdat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;coal_conv_pul_wo_ccs&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_coal.sdat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;coal_conv_pul_w_ccs&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_coal.sdat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;coal_igcc_wo_ccs&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_coal_igcc.sdat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;coal_igcc_w_ccs&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_coal_igcc_ccs.sdat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;gas_cc_wo_ccs&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_gas_cc.sdat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;gas_cc_w_ccs&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_gas_cc_ccs.sdat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;gas_ct_wo_ccs&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_gas_cc.sdat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;geothermal&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;hydro&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;nuclear_gen_ii&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_nuclear.sdat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;nuclear_gen_iii&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_nuclear.sdat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;oil_ct_wo_ccs&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_oil_baseload.sdat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;solar_csp&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_solar.sdat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;solar_pv_non_dist&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_solar.sdat&#39;</span><span class="p">,</span>
            <span class="s1">&#39;wind_onshore&#39;</span><span class="p">:</span> <span class="s1">&#39;suitability_wind.sdat&#39;</span><span class="p">}</span></div>


<div class="viewcode-block" id="buffer_flat_array"><a class="viewcode-back" href="../../cerf.html#cerf.utils.buffer_flat_array">[docs]</a><span class="k">def</span> <span class="nf">buffer_flat_array</span><span class="p">(</span><span class="n">target_index</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">,</span> <span class="n">ncells</span><span class="p">,</span> <span class="n">set_value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assign a value to the neighboring elements of a 1D array as if they</span>
<span class="sd">    were in 2D space. The number of neighbors are based on the `ncells` argument</span>
<span class="sd">    which is used to define the window around the target cell to be altered as</span>
<span class="sd">    if they were in 2D space.</span>

<span class="sd">    :param target_index:                Index of the target element in the 1D array</span>
<span class="sd">    :type target_index:                 int</span>

<span class="sd">    :param arr:                         A 1D array that has been flattened from a corresponding 2D array</span>
<span class="sd">    :type arr:                          ndarray</span>

<span class="sd">    :param nrows:                       The number of rows in the parent 2D array</span>
<span class="sd">    :type nrows:                        int</span>

<span class="sd">    :param ncols:                       The number of columns in the parent 2D array</span>
<span class="sd">    :type ncols:                        int</span>

<span class="sd">    :param ncells:                      The number of cells for the buffer extending as a radius</span>
<span class="sd">    :type ncells:                       int</span>

<span class="sd">    :param set_value:                   The value to set for the selected buffer</span>
<span class="sd">    :type set_value:                    int; float</span>

<span class="sd">    :return:                            [0] Modified 1D array</span>
<span class="sd">                                        [1] list of buffered indices</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># list to hold buffer indices for the target grid cell</span>
    <span class="n">buffer_indices</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># calculate the number of elements in the 2D grid space</span>
    <span class="n">ngrids</span> <span class="o">=</span> <span class="n">nrows</span> <span class="o">*</span> <span class="n">ncols</span>

    <span class="c1"># ensure that the target index is in the grid space</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">target_index</span> <span class="o">&lt;</span> <span class="n">ngrids</span><span class="p">:</span>

        <span class="c1"># target cell index bounds for the row</span>
        <span class="n">min_idx</span> <span class="o">=</span> <span class="n">target_index</span> <span class="o">-</span> <span class="n">ncells</span>
        <span class="n">max_idx</span> <span class="o">=</span> <span class="n">target_index</span> <span class="o">+</span> <span class="n">ncells</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># create target row limits</span>
        <span class="n">end_row_idx</span> <span class="o">=</span> <span class="n">target_index</span> <span class="o">+</span> <span class="n">ncols</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">target_index</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">start_row_idx</span> <span class="o">=</span> <span class="n">end_row_idx</span> <span class="o">-</span> <span class="p">(</span><span class="n">ncols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># do not let the index bleed past the row</span>
        <span class="k">if</span> <span class="n">max_idx</span> <span class="o">&gt;</span> <span class="n">end_row_idx</span><span class="p">:</span>
            <span class="n">max_idx</span> <span class="o">=</span> <span class="n">end_row_idx</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># do not let the index go negative</span>
        <span class="k">if</span> <span class="n">min_idx</span> <span class="o">&lt;</span> <span class="n">start_row_idx</span><span class="p">:</span>
            <span class="n">min_idx</span> <span class="o">=</span> <span class="n">start_row_idx</span>

        <span class="c1"># initialize above</span>
        <span class="n">min_above</span> <span class="o">=</span> <span class="n">min_idx</span> <span class="o">-</span> <span class="n">ncols</span>
        <span class="n">max_above</span> <span class="o">=</span> <span class="n">max_idx</span> <span class="o">-</span> <span class="n">ncols</span>

        <span class="c1"># initialize below</span>
        <span class="n">min_below</span> <span class="o">=</span> <span class="n">min_idx</span> <span class="o">+</span> <span class="n">ncols</span>
        <span class="n">max_below</span> <span class="o">=</span> <span class="n">max_idx</span> <span class="o">+</span> <span class="n">ncols</span>

        <span class="c1"># target row assignment</span>
        <span class="n">arr</span><span class="p">[</span><span class="n">min_idx</span><span class="p">:</span> <span class="n">max_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_value</span>

        <span class="c1"># add indices to buffer list</span>
        <span class="n">buffer_indices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">min_idx</span><span class="p">,</span> <span class="n">max_idx</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncells</span><span class="p">):</span>

            <span class="c1"># above</span>
            <span class="k">if</span> <span class="n">min_above</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">max_above</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">start_row_idx</span> <span class="o">&lt;</span> <span class="n">ngrids</span><span class="p">:</span>
                <span class="n">arr</span><span class="p">[</span><span class="n">min_above</span><span class="p">:</span> <span class="n">max_above</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_value</span>

                <span class="c1"># add indices to buffer list</span>
                <span class="n">buffer_indices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">min_above</span><span class="p">,</span> <span class="n">max_above</span><span class="p">)))</span>

            <span class="c1"># advance above to the next row</span>
            <span class="n">min_above</span> <span class="o">-=</span> <span class="n">ncols</span>
            <span class="n">max_above</span> <span class="o">-=</span> <span class="n">ncols</span>

            <span class="c1"># below</span>
            <span class="k">if</span> <span class="n">min_below</span> <span class="o">&lt;=</span> <span class="n">ngrids</span> <span class="ow">and</span> <span class="n">max_below</span> <span class="o">&lt;=</span> <span class="n">ngrids</span><span class="p">:</span>
                <span class="n">arr</span><span class="p">[</span><span class="n">min_below</span><span class="p">:</span> <span class="n">max_below</span><span class="p">]</span> <span class="o">=</span> <span class="n">set_value</span>

                <span class="c1"># add indices to buffer list</span>
                <span class="n">buffer_indices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">min_below</span><span class="p">,</span> <span class="n">max_below</span><span class="p">)))</span>

            <span class="c1"># advance below to the next row</span>
            <span class="n">min_below</span> <span class="o">+=</span> <span class="n">ncols</span>
            <span class="n">max_below</span> <span class="o">+=</span> <span class="n">ncols</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index: &#39;</span><span class="si">{</span><span class="n">target_index</span><span class="si">}</span><span class="s2">&#39; is not in the range of the grid space from 0 to </span><span class="si">{</span><span class="n">ngrids</span> <span class="o">-</span> <span class="mi">1</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">arr</span><span class="p">,</span> <span class="n">buffer_indices</span></div>


<div class="viewcode-block" id="array_to_raster"><a class="viewcode-back" href="../../cerf.html#cerf.utils.array_to_raster">[docs]</a><span class="k">def</span> <span class="nf">array_to_raster</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">template_raster_file</span><span class="p">,</span> <span class="n">output_raster_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write a raster file from a 2D array.&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">template_raster_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># update metadata</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
                        <span class="n">nodata</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_raster_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="raster_to_coord_arrays"><a class="viewcode-back" href="../../cerf.html#cerf.utils.raster_to_coord_arrays">[docs]</a><span class="k">def</span> <span class="nf">raster_to_coord_arrays</span><span class="p">(</span><span class="n">template_raster</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Use the template raster to create two 2D arrays containing the X and Y coordinates of every grid cell.</span>

<span class="sd">    :param template_raster:                 Full path with file name and extension to the input raster.</span>
<span class="sd">    :type template_raster:                  str</span>

<span class="sd">    :return:                                [0] 2D array of X coordinates</span>
<span class="sd">                                            [1] 2D array of Y coordinates</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Read the data</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="n">template_raster</span><span class="p">)</span>

    <span class="c1"># Compute the lon/lat coordinates with rasterio.warp.transform</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">da</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">da</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span></div>


<div class="viewcode-block" id="ingest_sited_data"><a class="viewcode-back" href="../../cerf.html#cerf.utils.ingest_sited_data">[docs]</a><span class="k">def</span> <span class="nf">ingest_sited_data</span><span class="p">(</span><span class="n">run_year</span><span class="p">,</span>
                      <span class="n">x_array</span><span class="p">,</span>
                      <span class="n">siting_data</span><span class="p">,</span>
                      <span class="n">template_raster_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Import sited data containing the locations and additional data to establish an initial suitability condition</span>
<span class="sd">    representing power plants and their siting buffer.</span>

<span class="sd">    Required fields are the following and they can appear anywhere in the CSV or data frame:</span>

<span class="sd">    xcoord:  the X coordinate of the site in meters in USA_Contiguous_Albers_Equal_Area_Conic (EPSG:  102003)</span>
<span class="sd">    ycoord:  the Y coordinate of the site in meters in USA_Contiguous_Albers_Equal_Area_Conic (EPSG:  102003)</span>
<span class="sd">    retirement_year:  the year (int four digit, e.g., 2050) that the power plant is to be decommissioned</span>
<span class="sd">    buffer_in_km:  the buffer around the site to apply in kilometers</span>

<span class="sd">    :param run_year:                        Four-digit year of the current run (e.g., 2050)</span>
<span class="sd">    :type run_year:                         int</span>

<span class="sd">    :param x_array:                         2D array of X coordinates for the entire grid space</span>
<span class="sd">    :type x_array:                          ndarray</span>

<span class="sd">    :param siting_data:                     Full path with file name and extension for the input siting file or a</span>
<span class="sd">                                            Pandas DataFrame</span>
<span class="sd">    :type siting_data:                      str, DataFrame</span>

<span class="sd">    :param template_raster_file:            Full path with file name and extension to the input template raster file</span>
<span class="sd">                                            containing a grid index value per grid cell.</span>
<span class="sd">    :type template_raster_file:             str</span>

<span class="sd">    :return:                                [0] 2D array of 0 (suitable) and 1 (unsuitable) values where 1 are the sites</span>
<span class="sd">                                            and their buffers of active power plants</span>

<span class="sd">                                            [1] Pandas DataFrame of active sites (not retired)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># assign input data to a data frame</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">siting_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">siting_data</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">siting_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">siting_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">sited_dtypes</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The user must pass either a CSV file path to &#39;sited_csv&#39; or a Pandas DataFrame to &#39;sited_df&#39;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">()</span>

    <span class="c1"># only keep sites that are not retired</span>
    <span class="n">df_active</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;retirement_year&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">run_year</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># initialize an array to hold the 0, 1 sited and buffer data</span>
    <span class="n">sited_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x_array</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

    <span class="c1"># generate the corresponding grid index for the input coordinate pairs</span>
    <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">template_raster_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">src</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># get array</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">n_cells</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">max_allowable_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">rasterio</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>

        <span class="k">if</span> <span class="n">n_cells</span> <span class="o">&gt;</span> <span class="n">max_allowable_cells</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Too many grid cells in array for a uint32 format.  Max allowable: </span><span class="si">{</span><span class="n">max_allowable_cells</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># create continuous index values from flat array and then reshape back to 2D</span>
        <span class="n">flat_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">index_arr</span> <span class="o">=</span> <span class="n">flat_arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>

        <span class="c1"># update data type</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpfile</span><span class="p">:</span>

        <span class="c1"># write array as spatial in a temp file</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">)</span> <span class="k">as</span> <span class="n">dest</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">index_arr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># read temp file to use for grid search</span>
        <span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">idx</span><span class="p">:</span>
            <span class="n">index_generator</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">df_active</span><span class="p">[[</span><span class="s2">&quot;xcoord&quot;</span><span class="p">,</span> <span class="s2">&quot;ycoord&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">located_index_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_generator</span><span class="p">]</span>

    <span class="c1"># give the input data frame the new index from the coordinate lookup</span>
    <span class="n">df_active</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">located_index_list</span>

    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">df_active</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>

        <span class="c1"># get the buffer size for the site</span>
        <span class="n">site_buffer_km</span> <span class="o">=</span> <span class="n">df_active</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_active</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ix</span><span class="p">][</span><span class="s1">&#39;buffer_in_km&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># apply the buffer to the site and set to the entire array</span>
        <span class="n">sited_arr</span> <span class="o">=</span> <span class="n">buffer_flat_array</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">sited_arr</span><span class="p">,</span> <span class="n">x_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">site_buffer_km</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">sited_arr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">),</span> <span class="n">df_active</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021-current, Battelle Memorial Institute.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>